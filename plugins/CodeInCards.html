<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>CodeInCards - Anki plugin</title>
  <link rel="stylesheet" type="text/css" href="anki.css" />
</head>
<body>
<h1>CodeInCards - an Anki plugin to embed Python code in cards/card templates</h1>

<h2>Description</h2>

<p>
This <a href="http://ichi2.net/anki/">Anki</a> plugin loads substition
"libraries" of <a href="http://www.python.org/">Python</a> functions and variables from
<span style="font-family:Courier,monospace">%pluginsFolder%/CodeInCards/*.py</span>
then provides syntax to let you substitute the results of library calls (or indeed
any other arbitrary Python code) into cards and/or card templates.
</p>

<p style="color:red; font-size:larger">Warning: This plugin is a potential
security hole.  Please read the section <a href="#security">"Security"</a>
below before deciding whether to install the plugin.</p>

<h2>Installation</h2>

<p>
Download using <a href="http://ichi2.net/anki/wiki/Plugins">Anki's plugin
browser</a> in the normal way; search for "codeincards".  You may also want the <a
href="default.py">example library</a> which you should save in the <span
style="font-family:Courier,monospace">%pluginsFolder%/CodeInCards/</span>
directory.
</p>

<h2>Syntax</h2>
<p>
Escapes may be included either encoded as HTML or among the markup (i.e. you
can enter them directly in the browser-editor field, or in the "HTML editor" window).
The following escape formats are supported.  The dollar-formats aim for brevity
over flexibility:
</p>

  <div style="color:blue; margin-left:3em; font-family:Courier,monospace">
  $varName
  </div>
    <div style="margin-left:6em; max-width:35em; ">
    Interpolate variable "varName".  Subscripting and dot-whatever
    isn't supported (yet!); use the bracketed format below instead.
    </div>

  <div style="color:blue; margin-left:3em; font-family:Courier,monospace">
  $functionName(...)
  </div>
    <p style="margin-left:6em; max-width:35em; ">
    Invoke <span style="font-family:Courier,monospace">functionName</span>
    with the supplied args, and interpolate the returned string, e.g.:
    </p>
      <div style="margin-left:9em; font-family:Courier,monospace">
      $myFunc(myVar, 'a string arg')
      </div>
    <p style="margin-left:6em; max-width:35em; ">
    The args list is considered to stop at the next closing bracket, even if
    it occurs in a string or after a nested function call, so these won't work:
    </p>
      <div style="margin-left:9em; font-family:Courier,monospace">
      $wontWork("a (broken) example")<br/>
      $alsoWontWork("some text", anotherFunc())
      </div>
    <p style="margin-left:6em; max-width:35em; ">
    ...but see <a href="#fieldsubst">Field Substitution</a> below for an exception.
    </p>
    <p style="margin-left:6em; max-width:35em; ">
    If you're intent on sticking with the dollar-format then you can usually
    hack around the string case above using Python's <span style="font-family:Courier,monospace">u''</span>
    string format and the escape <span style="font-family:Courier,monospace">\u0029</span>,
    or perhaps just the HTML entity <span style="font-family:Courier,monospace">&amp;#x0029;</span>:
    </p>
      <div style="margin-left:9em; font-family:Courier,monospace">
      $willWork(u"a \u0028working\u0029 example")<br/>
      $willWork("a <span style="font-family:Courier,monospace">&amp;#x0028;</span>working<span style="font-family:Courier,monospace">&amp;#x0029;</span> example")<br/>
      $stillWontWork("some text", anotherFunc())
      </div>
    <p style="margin-left:6em; max-width:35em; ">
    but the function call case still won't work and it might be easier
    just to use the bracketed forms below instead in both cases.
    </p>
    <p style="margin-left:6em; max-width:35em; ">
    You can split a function call over multiple lines:
    </p>
      <div style="margin-left:9em; font-family:Courier,monospace">
      $quotation('''<br/>
      Many were increasingly of the opinion that they'd all made a big mistake<br/>
      in coming down from the trees in the first place. And some said that even<br/>
      the trees had been a bad move, and that no one should ever have left the oceans.<br/>
      ''')
      </div>

<p>
The bracketed formats are more flexible but more verbose.  They accept
multiple lines and brackets are allowed; the only banned string is
<span style="font-family:Courier,monospace">%}</span>.  Note that in card
templates you'll need to use
<span style="font-family:Courier,monospace">{%% ... %%}</span>
and <span style="font-family:Courier,monospace">{%%= ... %%}</span> instead
because Anki uses % for field value substitutions (a poor choice of escape
characters on my part).
</p>

  <div style="color:blue; margin-left:3em; font-family:Courier,monospace">
  {%= &lt;expression&gt; %}
  </div>
    <p style="margin-left:6em; max-width:35em; ">
    Evaluates &lt;expression&gt; (a single expression) and substitutes
    result.  For example:
    </p>
      <div style="margin-left:9em; font-family:Courier,monospace">
      {%= 6 * 9 %}
      </div>
    <p style="margin-left:6em; max-width:35em; ">
    will yield "54" in the card or template (or "42" if you're a Hitchiker's Guide fan).  Function
    calls also work (brackets and all), e.g.:
    </p>
      <div style="margin-left:9em; font-family:Courier,monospace">
      {%= functionName("a (working) example", someOtherFunc()) %}
      </div>

  <div style="color:blue; margin-left:3em; font-family:Courier,monospace">
  {% &lt;code&gt; %}
  </div>
    <p style="margin-left:6em">
    Executes &lt;code&gt;.  Anything printed to <span style="font-family:Courier,monospace">sys.stdout</span> gets substituted, e.g.:
    </p>
      <div style="margin-left:9em; font-family:Courier,monospace">
      {%<br/>
      if random.randint(0, 1000000) == 42:<br/>
      <span style="white-space:pre">        print "The Ultimate Answer!"</span><br/>
      %}<br/>
      </div>

You can type a literal '$' as <span style="font-family:Courier,monospace">$$</span>.

You can separate a simple variable substitution from the surrounding text
without introducing trailing whitespace by using a trailing exclamation mark,
so if <span style="font-family:Courier,monospace">ABOUT</span> was set to
<span style="font-family:Courier,monospace">"~"</span> then
<span style="font-family:Courier,monospace">$ABOUT!ten</span> would yield
<span style="font-family:Courier,monospace">~ten</span>.

<h3 id="fieldsubst">Field substitution</h3>

<p>
When you save this in the card template editor:
</p>
  <div style="margin-left:3em; font-family:Courier,monospace">
  $myFunc('foo %(fieldName)s bar')
  </div>
<p>
...Anki regenerates the HTML for all the cards, which expands
<span style="font-family:Courier,monospace">%(fieldName)s</span>
and wraps it in some formatting code.  By the time the card gets rendered
for (p)review and CodeInCards escapes get interpreted, CodeInCards will see
something like this:
</p>
  <div style="margin-left:3em; font-family:Courier,monospace">
  $myFunc('foo &lt;span id="fm109283749"&gt;fieldContents&lt;span&gt; bar')
  </div>
<p>
Provided <span style="font-family:Courier,monospace">fieldContents</span>
doesn't contain any brackets itself, this works fine - and is an exception to
the rule that brackets aren't allowed in <span style="font-family:Courier,monospace">$fn()</span>
escapes - but you must take care to avoid double-quotes for the argument to
<span style="font-family:Courier,monospace">myFunc()</span> to prevent a
clash with Anki's <span style="font-family:Courier,monospace">&lt;span&gt;</span>
tag attribute.  If your <span style="font-family:Courier,monospace">%(string)s</span>
might contain single quotes then you'll have to use Python's tripled quotes
around it.  If it might contain closing brackets then you'll have to use
<span style="font-family:Courier,monospace">{% ... %}</span> syntax.  If it might
contain tripled quotes, that's probably a sign from the Gods.
</p>

<h2>Execution Environment</h2>

<p>
Code in libraries is executed when Anki loads the CodeInCards plugin.  Code in
escapes is executed at the point that the card gets displayed.
</p>

<p>
The CodeInCards module provides the following symbols for use by libraries:
</p>
<dl style="margin-left:3em;">
  <dt style="font-weight:bold; font-family:Courier,monospace">QorA</dt>
  <dd>'q' or 'a', depending on which side of the card is being rendered</dd>
  <dt style="font-weight:bold; font-family:Courier,monospace">card</dt>
  <dd>the card being rendered; see the Anki source for structure details</dd>
  <dt style="font-weight:bold; font-family:Courier,monospace">showHTML</dt>
  <dd>if <span style="font-weight:bold; font-family:Courier,monospace">True</span>, escape the HTML before rendering; this can aid in debugging an escape</dd>
</dl>

<p>
Escapes have access to all globals in your libraries, plus the following
symbols provided for convenience/brevity:
</p>
<dl style="margin-left:3em;">
  <dt style="font-weight:bold; font-family:Courier,monospace">CIC</dt>
  <dd>can be used as if you had said <span style="font-weight:bold; font-family:Courier,monospace">import CodeInCards as CIC</span> at the start of your escape</dd>
  <dt style="font-weight:bold; font-family:Courier,monospace">QorA</dt>
  <dd>same as saying <span style="font-weight:bold; font-family:Courier,monospace">CIC.QorA</span></dd>
  <dt style="font-weight:bold; font-family:Courier,monospace">card</dt>
  <dd>same as saying <span style="font-weight:bold; font-family:Courier,monospace">CIC.card</span></dd>
</dl>

<p>
Compile error handling depends on where the erroneous code is.  If your
substitution library has errors this'll be flagged up with the normal plugin
error dialog when Anki loads CodeInCards.  If an escape contains code with
errors then the error will get interpolated as a big red HTML-ised string every
time you (p)review the card.
</p>

<p>
The string "&lt;br /&gt;" is removed from within code if present before
execution.  This allows you to add code in the card editor as well as
card templates but means you can't include a BR in an escape.  If
that matters to you, define a variable in your library called "BR" and
use than in place of "&lt;br/&gt;".  No other HTML is removed, so be careful
not to style any part of an escape entered in a card editor field, and 
note that &lt; and &gt; will cause cryptic problems.
</p>


<h2 id="security">Security</h2>
<p>
Like any feature that provides ways to execute code, this plugin is inherently
a potential security hole.  If someone/something deliberately or accidentally
causes you to run CodeInCard escapes you didn't write, or even if you just
write buggy escapes, it could lead to you losing data and/or control of your
computer (e.g. getting infected with viruses and trojans).
</p>

<p>
To minimise this risk, CodeInCards will only execute escapes in decks it
trusts.  Decks are untrusted by default and use of escapes in an untrusted deck
will generate a warning message instead of running them.  To trust a deck use
Tools&rarr;Advanced&rarr;CodeInCards Deck Trust... and read the warning.  Deck
trust settings are per installation - a deck trusted by you and exported/shared
will not be trusted by anyone else unless they go through this step too.  The
deck's creation time and name are used together as an identifier, so if you use
the OS to copy a deck you already trust and give it the same name then the copy
will be trusted too (but again, only by your installation).
</p>

<p>
You are strongly advised to trust only decks which you've built yourself,
from scratch, and which are not shared or synchronised online.  You have been
warned!
</p>

<h2>Caveats</h2>

<ul>
  <li>At the moment there's no way to prevent the escapes appearing in the browser, so cards start to look quite ugly.</li>
  <li>It's too easy to get carried away and implement your own SRS mini-language packed with syntactic sugar.</li>
</ul>

<h2>To Do</h2>

<ul>
  <li>add individual fact fields alongside <span style="font-family:Courier,monospace;">QorA</span> and <span style="font-family:Courier,monospace">card</span> in a dict (need to marry up <span style="font-family:Courier,monospace">card.fact.values</span> with <span style="font-family:Courier,monospace">card.model.names</span>)</li>
  <li>provide a way to get called back before/after substitution of a card; perhaps have CIC look for <span style="font-family:Courier,monospace">CICstart</span> and <span style="font-family:Courier,monospace">CICstop</span> within a library module and call them if they exist</li>
  <li>implement m4's '<span style="font-family:Courier,monospace">dnl</span>' feature - perhaps by terminating a multiline with "<span style="font-family:Courier,monospace">%}.</span>" instead of "<span style="font-family:Courier,monospace">%}</span>"</li>
  <li>support <span style="font-family:Courier,monospace">$foo['index']</span> and maybe <span style="font-family:Courier,monospace">$foo.bar</span> and <span style="font-family:Courier,monospace">$foo.bar()</span></li>
  <li>remove escapes from browser; there's no hook, but a sick hack might be to wrap <span style="font-family:Courier,monospace">stripHTML()</span></li>
</ul>

<h2>Licence</h2>
<p>
Copyright 2010 Isaac Wilcox.  This program is free software: you can
redistribute it and/or modify it under the terms of the
<a href="http://www.gnu.org/licenses/gpl-3.0.html">GNU General Public License version 3</a>
as published by the Free Software Foundation.
</p>

<h2>Support</h2>
<p>
You can reach the author at zakwilcox+codeincards@gmail.com.
</p>

<p><i>$Id$</i></p>
</body>
</html>
