<html>
<head><title>CodeInCards - Anki plugin</title></head>
<body>
<h3>CodeInCards - an Anki plugin to embed Python code in cards/card templates</h3>

<p>
Copyright 2010 Isaac Wilcox.  This program is free software: you can
redistribute it and/or modify it under the terms of the GNU General Public
License version 3 as published by the Free Software Foundation.
</p>

<p style="color:red; font-size:larger">WARNING: This plugin is a GAPING SECURITY HOLE if you ever import cards from untrusted sources.</p>

<p> 
This plugin loads substition "libraries" of functions and variables from
<span style="font-family:Courier,monospace">%pluginsFolder%/CodeInCards/*.py</span>
then provides syntax to let you substitute the results library calls (or indeed
any other arbitrary Python code) into cards.
</p>

<p>
Escapes may be included either encoded as HTML or among the markup (i.e. you
can enter them directly in the browser-editor field, or in the "HTML editor" window).
The following escape formats are supported.  The dollar-formats aim for brevity
over flexibility:
</p>

<p>
  <div style="color:blue; margin-left:3em; font-family:Courier,monospace">
  $varName
  </div>
  <div style="margin-left:6em">
    Interpolate variable "varName".  Subscripting and dot-whatever
    isn't supported (yet!) but you can use another format.
  </div>
</p>

<p>
  <div style="color:blue; margin-left:3em; font-family:Courier,monospace">
  $functionName(...)
  </div>
  <div style="margin-left:6em">
    Invoke <span style="font-family:Courier,monospace">functionName</span> with the supplied args, and interpolate the returned
    string, e.g.:
  </div>
  <div style="margin-left:9em; margin-top:1em; margin-bottom:1em; font-family:Courier,monospace">
      $myFunc(myVar, "another arg")
  </div>
  <div style="margin-left:6em">
    A note on brackets.  Substitutions of fields are fine because Anki substitutes <span style="font-family:Courier,monospace">%(fieldName)s</span> at addition/edit time (way before code escapes get interpreted):
  </div>
    <div style="margin-left:9em; margin-top:1em; margin-bottom:1em; font-family:Courier,monospace">
      $willWork('question field is %(question)s')
    </div>
  <div style="margin-left:6em">
    There's a catch: when you say:
  </div>
    <div style="margin-left:9em; margin-top:1em; margin-bottom:1em; font-family:Courier,monospace">
      %(fieldName)s
    </div>
  <div style="margin-left:6em">
    ...Anki actually substitutes something like this in order to implement your field formatting settings:
  </div>
    <div style="margin-left:9em; margin-top:1em; margin-bottom:1em; font-family:Courier,monospace">
      &lt;span id="fm109283749"&gt;fieldContents&lt;span&gt;
    </div>
  <div style="margin-left:6em">
    ...so you must single-quote these substitutions to avoid unescaped quotes.
    No other closing brackets are allowed in the args (that's the price you pay for a compact escape format), so you can't say either of these in dollar-format:
  </div>
    <div style="margin-left:9em; margin-top:1em; margin-bottom:1em; font-family:Courier,monospace">
      $wontWork("a (broken) example")<br/>
      $alsoWontWork("some text", anotherFunc())
    </div>
  <div style="margin-left:6em">
    However, read on for another way to do this.
  </div>
</p>

<p>
The bracketed formats are more flexible but more verbose:
</p>

<p>
  <div style="color:blue; margin-left:3em; font-family:Courier,monospace">
  {%= &lt;expression&gt; %}
  </div>
  <div style="margin-left:6em">
    Evaluates &lt;expression&gt; (a single expression) and substitutes
    result.  For example:
  </div>
  <div style="margin-left:9em; margin-top:1em; margin-bottom:1em; font-family:Courier,monospace">
      {%= 6 * 9 %}
  </div>
  <div style="margin-left:6em">
    will yield "54" in the card or template (or "42" if you're a Hitchiker's Guide fan).  Function
    calls also work (brackets and all), e.g.:
  </div>
  <div style="margin-left:9em; margin-top:1em; margin-bottom:1em; font-family:Courier,monospace">
      {%= functionName("a (working) example", someOtherFunc()) %}
  </div>
</p>

<p>
  <div style="color:blue; margin-left:3em; font-family:Courier,monospace">
  {% &lt;code&gt; %}
  </div>
  <div style="margin-left:6em">
    Executes &lt;code&gt;.  Anything printed to <span style="font-family:Courier,monospace">sys.stdout</span> gets substituted, e.g.:
  </div>
  <div style="margin-left:9em; margin-top:1em; margin-bottom:1em; font-family:Courier,monospace">
      {%<br/>
      if random.randint(0, 1000000) == 42:<br/>
      <span style="white-space:pre">        print "The Ultimate Answer!"</span><br/>
      %}<br/>
  </div>
</p>

<p>
Apart from globals in your libraries you can also use the following
symbols:
</p>
<dl style="margin-left:3em;">
  <dt style="font-weight:bold; font-family:Courier,monospace">QorA</dt>
  <dd>'q' or 'a', depending on which side of the card is being rendered</dd>
  <dt style="font-weight:bold; font-family:Courier,monospace">card</dt>
  <dd>the card being rendered; see the Anki source</dd>
</dl>

<p>
Compile error handling depends on where the erroneous code is.  If your substitution library has errors this'll be flagged up with the normal plugin error dialog when Anki loads CodeInCards.  If an escape contains code with errors then the error will get interpolated as a big red HTML-ised string every time you (p)review the card.
<p>

<p>
The string "&lt;br /&gt;" is removed from within code if present before
execution.  This allows you to add code in the card editor as well as
card templates but means you can't include a BR in an escape.  If
that matters to you, define a variable in your library called "BR" and
use than in place of "&lt;br/&gt;".  No other HTML is removed, so be careful
not to style any part of an escape entered in a card editor field.
</p>

<p>
You can find a small example library at <a href="http://bit.ly/codeincards">http://bit.ly/codeincards</a>.
Save it in <span style="font-family:Courier,monospace">%pluginsFolder%/CodeInCards/</span> and read it to see some
trivial examples.
</p>
 
<p>
Caveats:
</p>
<ul>
  <li>This plugin is a gaping security hole if you ever import cards from untrusted sources.</li>
  <li>At the moment there's no way to prevent the escapes appearing in the browser, so cards start to look quite ugly.</li>
  <li>It's too easy to get carried away and implement your own SRS mini-language packed with syntactic sugar.</li>
</ul>

<p>
TODO:
</p>
<ul>
  <li>make it more secure; Damien's idea of a local list of trusted decks seems the safest fix</li>
  <li>add individual fact fields alongside <span style="font-family:Courier,monospace;">QorA</span> and <span style="font-family:Courier,monospace">card</span> in a dict (need to marry up <span style="font-family:Courier,monospace">card.fact.values</span> with <span style="font-family:Courier,monospace">card.model.names</span>)</li>
  <li>implement m4's '<span style="font-family:Courier,monospace">dnl</span>' feature - perhaps by terminating a multiline with "<span style="font-family:Courier,monospace">%}.</span>" instead of "<span style="font-family:Courier,monospace">%}</span>"</li>
  <li>reload libraries without restarting Anki</li>
  <li>support <span style="font-family:Courier,monospace">$foo['index']</span> and maybe <span style="font-family:Courier,monospace">$foo.bar</span> and <span style="font-family:Courier,monospace">$foo.bar()</span></li>
  <li>remove escapes from browser; there's no hook, but a sick hack might be to wrap <span style="font-family:Courier,monospace">stripHTML()</li>
</ul>
</body>
