<html>
<head><title>CodeInCards - Anki plugin</title></head>
<body>
<h3>CodeInCards - an Anki plugin to embed Python code in cards/card templates</h3>

<p>
Copyright 2010 Isaac Wilcox.  This program is free software: you can
redistribute it and/or modify it under the terms of the GNU General Public
License version 3 as published by the Free Software Foundation.
</p>

<p style="color:red; font-size:larger">WARNING: This plugin is a GAPING SECURITY HOLE if you ever import cards from untrusted sources.</p>

<p> 
This plugin loads substition "libraries" of functions and variables from
<span style="font-family:Courier,monospace">%pluginsFolder%/CodeInCards/*.py</span>
then provides syntax to let you substitute the results library calls (or indeed
any other arbitrary Python code) into cards.
</p>

<p>
Escapes may be included either encoded as HTML or among the markup (i.e. you
can enter them directly in the browser-editor field, or in the "HTML editor" window).
The following escape formats are supported.  The dollar-formats aim for brevity
over flexibility:
</p>

<p>
  <div style="color:blue; margin-left:3em; font-family:Courier,monospace">
  $varName
  </div>
  <div style="margin-left:6em">
    Interpolate variable "varName".  Subscripting and dot-whatever
    isn't supported (yet!) but you can use another format.
  </div>
</p>

<p>
  <div style="color:blue; margin-left:3em; font-family:Courier,monospace">
  $functionName(...)
  </div>
  <div style="margin-left:6em">
    Invoke <span style="font-family:Courier,monospace">functionName</span> with the supplied args, and interpolate the returned
    string, e.g.:
  </div>
  <div style="margin-left:9em; margin-top:1em; margin-bottom:1em; font-family:Courier,monospace">
      $myFunc(myVar, "another arg")
  </div>
  <div style="margin-left:6em">
    When you save this in the card template editor:
  </div>
    <div style="margin-left:9em; margin-top:1em; margin-bottom:1em; font-family:Courier,monospace">
      $myFunc('foo %(fieldName)s bar')
    </div>
  <div style="margin-left:6em; width:35em; ">
    ...Anki regenerates the HTML for all the cards, which expands
    <span style="font-family:Courier,monospace">%(fieldName)s</span>
    and wraps it in some formatting code.  By the time the card gets rendered
    for (p)review and CodeInCards escapes get interpreted, CodeInCards will see
    something like this:
  </div>
    <div style="margin-left:9em; margin-top:1em; margin-bottom:1em; font-family:Courier,monospace">
      $myFunc('foo &lt;span id="fm109283749"&gt;fieldContents&lt;span&gt; bar')
    </div>
  <p style="margin-left:6em; width:35em;">
    This works fine but you must avoid double-quotes for the argument to
    <span style="font-family:Courier,monospace">myFunc()</span> to prevent a
    clash with Anki's <span style="font-family:Courier,monospace">&lt;span&gt;</span>
    tag attribute.
  </p>
  <p style="margin-left:6em; width:35em;">
    Apart from this special case, closing brackets are not allowed in the args
    (that's the price you pay for a compact escape format), so you can't say
    either of these in dollar-format:
  </p>
    <div style="margin-left:9em; margin-top:1em; margin-bottom:1em; font-family:Courier,monospace">
      $wontWork("a (broken) example")<br/>
      $alsoWontWork("some text", anotherFunc())
    </div>
  <div style="margin-left:6em">
    Instead, use the bracketed forms below to achieve this.
  </div>
</p>

<p>
The bracketed formats are more flexible but more verbose:
</p>

<p>
  <div style="color:blue; margin-left:3em; font-family:Courier,monospace">
  {%= &lt;expression&gt; %}
  </div>
  <div style="margin-left:6em">
    Evaluates &lt;expression&gt; (a single expression) and substitutes
    result.  For example:
  </div>
  <div style="margin-left:9em; margin-top:1em; margin-bottom:1em; font-family:Courier,monospace">
      {%= 6 * 9 %}
  </div>
  <div style="margin-left:6em">
    will yield "54" in the card or template (or "42" if you're a Hitchiker's Guide fan).  Function
    calls also work (brackets and all), e.g.:
  </div>
  <div style="margin-left:9em; margin-top:1em; margin-bottom:1em; font-family:Courier,monospace">
      {%= functionName("a (working) example", someOtherFunc()) %}
  </div>
</p>

<p>
  <div style="color:blue; margin-left:3em; font-family:Courier,monospace">
  {% &lt;code&gt; %}
  </div>
  <div style="margin-left:6em">
    Executes &lt;code&gt;.  Anything printed to <span style="font-family:Courier,monospace">sys.stdout</span> gets substituted, e.g.:
  </div>
  <div style="margin-left:9em; margin-top:1em; margin-bottom:1em; font-family:Courier,monospace">
      {%<br/>
      if random.randint(0, 1000000) == 42:<br/>
      <span style="white-space:pre">        print "The Ultimate Answer!"</span><br/>
      %}<br/>
  </div>
</p>

<p>
Code in libraries is executed when Anki loads the CodeInCards plugin.  Code in
escapes is executed at the point that the card gets displayed.
</p>

<p>
The CodeInCards module provides the following symbols for use by libraries:
</p>
<dl style="margin-left:3em;">
  <dt style="font-weight:bold; font-family:Courier,monospace">QorA</dt>
  <dd>'q' or 'a', depending on which side of the card is being rendered</dd>
  <dt style="font-weight:bold; font-family:Courier,monospace">card</dt>
  <dd>the card being rendered; see the Anki source for structure details</dd>
  <dt style="font-weight:bold; font-family:Courier,monospace">showHTML</dt>
  <dd>if <span style="font-weight:bold; font-family:Courier,monospace">True</span>, escape the HTML before rendering; this can aid in debugging an escape</dd>
</dl>

<p>
Escapes have access to all globals in your libraries, plus the following
symbols provided for convenience/brevity:
</p>
<dl style="margin-left:3em;">
  <dt style="font-weight:bold; font-family:Courier,monospace">CIC</dt>
  <dd>can be used as if you had said <span style="font-weight:bold; font-family:Courier,monospace">import CodeInCards as CIC</span> at the start of your escape</dd>
  <dt style="font-weight:bold; font-family:Courier,monospace">QorA</dt>
  <dd>same as saying <span style="font-weight:bold; font-family:Courier,monospace">CIC.QorA</span></dd>
  <dt style="font-weight:bold; font-family:Courier,monospace">card</dt>
  <dd>same as saying <span style="font-weight:bold; font-family:Courier,monospace">CIC.card</span></dd>
</dl>

<p>
Compile error handling depends on where the erroneous code is.  If your
substitution library has errors this'll be flagged up with the normal plugin
error dialog when Anki loads CodeInCards.  If an escape contains code with
errors then the error will get interpolated as a big red HTML-ised string every
time you (p)review the card.
<p>

<p>
The string "&lt;br /&gt;" is removed from within code if present before
execution.  This allows you to add code in the card editor as well as
card templates but means you can't include a BR in an escape.  If
that matters to you, define a variable in your library called "BR" and
use than in place of "&lt;br/&gt;".  No other HTML is removed, so be careful
not to style any part of an escape entered in a card editor field.
</p>

<p>
You can find a small example library at <a href="http://bit.ly/codeincards">http://bit.ly/codeincards</a>.
Save it in <span style="font-family:Courier,monospace">%pluginsFolder%/CodeInCards/</span> and read it to see some
trivial examples.
</p>
 
<p>
Caveats:
</p>
<ul>
  <li>This plugin is a gaping security hole if you ever import cards from untrusted sources.</li>
  <li>At the moment there's no way to prevent the escapes appearing in the browser, so cards start to look quite ugly.</li>
  <li>It's too easy to get carried away and implement your own SRS mini-language packed with syntactic sugar.</li>
</ul>

<p>
TODO:
</p>
<ul>
  <li>add individual fact fields alongside <span style="font-family:Courier,monospace;">QorA</span> and <span style="font-family:Courier,monospace">card</span> in a dict (need to marry up <span style="font-family:Courier,monospace">card.fact.values</span> with <span style="font-family:Courier,monospace">card.model.names</span>)</li>
  <li>implement m4's '<span style="font-family:Courier,monospace">dnl</span>' feature - perhaps by terminating a multiline with "<span style="font-family:Courier,monospace">%}.</span>" instead of "<span style="font-family:Courier,monospace">%}</span>"</li>
  <li>reload libraries without restarting Anki; you might be able to hack this by using <span style="font-family:Courier,monospace">reload(yourModule)</span> in escapes</li>
  <li>support <span style="font-family:Courier,monospace">$foo['index']</span> and maybe <span style="font-family:Courier,monospace">$foo.bar</span> and <span style="font-family:Courier,monospace">$foo.bar()</span></li>
  <li>remove escapes from browser; there's no hook, but a sick hack might be to wrap <span style="font-family:Courier,monospace">stripHTML()</span></li>
</ul>
<p><i>$Id$</i></p>
</body>
</html>
